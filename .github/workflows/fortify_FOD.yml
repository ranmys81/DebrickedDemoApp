# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

################################################################################################################################################
# Fortify Application Security provides your team with solutions to empower DevSecOps practices, enable cloud transformation, and secure your  #
# software supply chain. To learn more about Fortify, start a free trial or contact our sales team, visit fortify.com.                         #
#                                                                                                                                              #
# Use this starter workflow as a basis for integrating Fortify Application Security Testing into your GitHub workflows. This template          #
# demonstrates the steps to package the code+dependencies, initiate a scan, and optionally import SAST vulnerabilities into GitHub Security    #
# Code Scanning Alerts. Additional information is available in the workflow comments and the Fortify AST Action / fcli / Fortify product       #
# documentation. If you need additional assistance, please contact Fortify support.                                                            #
################################################################################################################################################

name: Fortify FoD Scan

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  fortify-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # FoD uploader is a Java JAR
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Create source zip
        run: |
          sudo apt-get update
          sudo apt-get install -y zip
          zip -r source.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "**/node_modules/*" \
            -x "**/target/*" \
            -x "**/build/*" \
            -x "**/dist/*"

      # IMPORTANT: Download the real uploader from GitHub release (not FoD /Tools/)
      - name: Download FoD Uploader (FoDUpload.jar)
        run: |
          curl -L -o FoDUpload.jar https://github.com/fod-dev/fod-uploader-java/releases/latest/download/FoDUpload.jar
          ls -lh FoDUpload.jar
          file FoDUpload.jar
          jar tf FoDUpload.jar | head -n 5

      - name: Upload to FoD and start Static Scan
        env:
          FOD_CLIENT_ID: ${{ secrets.FOD_CLIENT_ID }}
          FOD_CLIENT_SECRET: ${{ secrets.FOD_CLIENT_SECRET }}
        run: |
          java -jar FoDUpload.jar \
            -z source.zip \
            -aurl https://emea.fortify.com \
            -rid 185870 \
            -tc "${FOD_CLIENT_ID}" \
            -ts "${FOD_CLIENT_SECRET}"
